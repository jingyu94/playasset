# PlayAsset 네이밍/온톨로지/LLM 캐시 운영 가이드 (2026)

## 최신 현행화 (2026-02-16)
- `V13__tm_runtime_config_and_seed.sql` 적용
- 규칙/멘트 하드코딩 이관:
  - `ADVISOR_RULE`, `ADVISOR_MESSAGE`, `SIMULATION_MESSAGE`
- 관리자 기준정보 API/화면 반영:
  - 조회: `GET /api/v1/admin/runtime-configs`
  - 수정: `PUT /api/v1/admin/runtime-configs/{groupCode}/{configKey}`
- 원칙:
  - 사용자 노출 문구/임계값은 DB 기준정보 우선
  - 누락 시 코드 fallback 사용
  - 관리자 수정 시 `runtimeConfig` 및 관련 캐시 무효화

## 1) DB 네이밍 규칙 (TM/TD/TX)
- `TM_{DOMAIN}_{ENTITY}_MAIN`: 기준/마스터 테이블
- `TD_{DOMAIN}_{ENTITY}_DETAIL`: 마스터 하위 상세 테이블
- `TX_{DOMAIN}_{PROCESS}_LOG`: 트랜잭션/로그/이력 테이블
- 컬럼: `snake_case`
- PK/FK/UK/IX 규칙
  - `PK_{TABLE}`
  - `FK_{FROM}_{TO}`
  - `UK_{TABLE}_{COLS}`
  - `IX_{TABLE}_{COLS}`

적용 상태:
- `TM_STD_CODE_MAIN`, `TM_STD_CODE_ITEM_MAIN`, `TM_ONTOLOGY_TERM_MAIN`
- `TM_STD_RUNTIME_CONFIG_MAIN` (규칙/멘트 런타임 기준정보)
- `TM_AUTH_GROUP_MAIN`, `TM_AUTH_GROUP_PERMISSION_MAP`, `TM_AUTH_GROUP_USER_MAP`
- `TM_INVEST_PROFILE_MAIN`, `TM_LLM_PROMPT_MAIN`
- `TM_DB_NAMING_RULE_MAIN`, `TX_LLM_PROMPT_EXEC_LOG`

## 2) 온톨로지 운영 원칙
- 표준 형식: `SKOS` 기반 용어 정의
- 저장소: `TM_ONTOLOGY_TERM_MAIN`
  - `skos_pref_label`: 대표 용어
  - `skos_alt_labels`: 동의어/대체어
  - `related_term_cds`: 연관 용어
- 도메인 분리: `PORTFOLIO`, `LLM`, `RISK` 등

운영 방식:
- 신규 지표/기능은 먼저 온톨로지 항목 정의 후 API/화면 반영
- 사용자 노출 문구(툴팁/설명)는 온톨로지 정의와 동기화

## 3) 투자성향 개인화 설계
- 투자성향은 설문 응답 기반으로 `TM_INVEST_PROFILE_MAIN` 저장
- 서버 추천 로직(리밸런싱/ETF)에서 `risk_tier`, `score`, `profile_key` 반영
- LLM 프롬프트 페이로드에 구조화 JSON으로 전달
  - `riskProfile`, `metrics`, `positions`, `rebalancingActions`, `etfRecommendations`, `constraints`

## 4) LLM/API 캐싱 계층
- Redis 캐시 이름
  - `investmentProfile`
  - `llmPromptTemplate`
  - `llmPromptPayload`
  - `externalMarketApi`
  - `externalNewsApi`
- TTL
  - 프롬프트 템플릿: 1시간
  - 프롬프트 페이로드: 15분
  - 외부 시세 API: 30초
  - 외부 뉴스 API: 5분
- 실행 로그
  - `TX_LLM_PROMPT_EXEC_LOG`에 캐시 히트/상태 코드 기록

## 5) 관리자 운영 확장
- 관리자 API
  - 유료 호출 정책(일일 한도/활성화)
  - 사용자 역할(USER/OPERATOR/ADMIN)
  - 권한 그룹 조회/권한 변경
  - 사용자-그룹 매핑 변경
  - 런타임 기준정보 조회/수정
    - `GET /api/v1/admin/runtime-configs?groupCode=ADVISOR_RULE`
    - `PUT /api/v1/admin/runtime-configs/{groupCode}/{configKey}`
- 앱 관리자 탭
  - `호출 정책`, `권한 그룹`, `유저 관리` 하위 탭 제공
  - `기준정보` 탭 제공 (ADVISOR_RULE/ADVISOR_MESSAGE/SIMULATION_MESSAGE)

## 5-1) 하드코딩 제거 원칙 (현행)
- 서비스 로직의 조건값(임계치/추천개수/점수 기준)은 `ADVISOR_RULE`로 관리
- 사용자 노출 문구(요약/추천/주의/시뮬레이션 노트)는 `ADVISOR_MESSAGE`, `SIMULATION_MESSAGE`로 관리
- 기본 전략
  - DB 값이 있으면 DB 값 우선 사용
  - 누락 시 코드 기본값 fallback
  - 관리자 수정 시 Redis `runtimeConfig` 캐시 무효화 + 포트폴리오 캐시 무효화

주요 이관 항목:
- 리스크 레벨 판정 임계치 (`high/medium` 변동성·낙폭·집중도)
- 안정구간 판정 임계치 (변동성/낙폭/집중도/분산점수/갭)
- 리밸런싱 임계치 (티어별 목표비중/편차 임계치/최대 추천건수)
- ETF 추천 최대 건수 및 사유 템플릿
- AI 진단 headline/summary/keyPoints/cautions 템플릿
- 시뮬레이터 안내 문구/빈데이터 문구/기간 검증 에러 문구

## 6) 추가 인프라 권장
- API Gateway: 인증/레이트리밋/요금 정책 통합
- 메시징: Kafka (이벤트 스트림, 비동기 재처리)
- 배치/워크플로우: Airflow or Argo Workflows
- 관측성: Prometheus + Grafana + Loki + OpenTelemetry
- 시크릿 관리: AWS Secrets Manager or Vault
- 데이터 계층
  - OLTP: MySQL
  - 캐시: Redis
  - 분석: ClickHouse/BigQuery(확장 시)

## 7) 수동 개입 체크포인트
- 외부 API Key 주입
- LLM 모델/엔드포인트 연결
- 운영 환경 Redis/Kafka 접속 정보
- 관리자 초기 그룹/권한 정책 검수
- 런타임 기준정보 초깃값 검수
  - `ADVISOR_RULE`: 임계치/추천건수
  - `ADVISOR_MESSAGE`: 진단/추천 멘트
  - `SIMULATION_MESSAGE`: 시뮬레이터 안내 문구
