# 기간 수익 시뮬레이터 파이프라인 (2026)

## 1. 목적
- 현재 보유 포트폴리오를 기준으로
- `매수일(또는 사용자 지정 시작일) ~ 기준일` 사이
- 데이터 기반(과거 종가) 수익 시뮬레이션 제공

## 2. 데이터 모델
1. `portfolio_simulation_snapshots`
- 사용자별 일자 스냅샷 캐시
- 컬럼
  - `user_id`
  - `snapshot_date`
  - `simulated_value`
  - `base_value`
  - `cumulative_return_pct`
  - `daily_return_pct`
  - `drawdown_pct`
- 목적: 조회 API에서 빠른 응답, UI 차트 즉시 렌더링

## 3. 계산 규칙
1. 시뮬레이션 가치
- `simulated_value = Σ(현재 보유수량 * 해당일 종가)`

2. 수익률
- 누적 수익률: `(현재가치 - 시작가치) / 시작가치`
- 일간 수익률: `(당일가치 - 전일가치) / 전일가치`

3. MDD
- 누적 최고점 대비 하락률
- `drawdown = (peak - current) / peak`

4. 연환산 수익률
- 기간 90일 미만: 기간 수익률과 동일 표기(과대 해석 방지)
- 기간 90일 이상: CAGR 기반 연환산

## 4. 배치 파이프라인
1. 배치 컴포넌트
- `PortfolioSimulationBatchService`

2. 스케줄
- `app.batch.simulator-refresh-ms` (기본 6시간)
- `app.batch.simulator-lookback-days` (기본 730일)

3. 처리 흐름
1. 보유 포지션 있는 사용자 목록 조회
2. 사용자별 시계열 가치 계산
3. 스냅샷 캐시 업서트
4. `ingestion_jobs`에 성공/실패 로깅

## 5. 조회 API
1. 엔드포인트
- `GET /api/v1/users/{userId}/portfolio/simulation`
- Query
  - `startDate` (선택, yyyy-MM-dd)
  - `endDate` (선택, yyyy-MM-dd)

2. 응답
- 기간 요약(시작/종료가치, 손익금액/수익률, 연환산, MDD)
- 시계열 타임라인(차트용)
- 종목별 기여도(시작가/기준가/손익)
- 주의/해석 노트

## 6. UX 반영 포인트
1. 프리셋 기간 버튼
- 1개월, 3개월, 6개월, 1년, 매수일 기준

2. 사용자 지정 기간
- 시작일/기준일 캘린더 선택

3. 시각화
- 누적 수익 곡선 차트
- 종목 기여도 TOP N + 더보기/접기

4. 해석 안정성
- 단기 구간 연환산 수치 왜곡 방지 문구 제공
- 수수료/세금/중간 리밸런싱 미반영 고지
