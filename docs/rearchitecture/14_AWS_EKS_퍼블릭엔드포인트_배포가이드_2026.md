# 14. AWS EKS 퍼블릭 엔드포인트 배포 가이드 (2026)

## 0) 목표
- `playasset-web`를 퍼블릭 도메인으로 공개
- `playasset-server` API를 같은 도메인 `/api` 경로로 공개
- 스택: ECR + EKS + AWS Load Balancer Controller + Route53 + ACM

## 1) 사전 준비
- AWS CLI, kubectl, helm, eksctl 설치
- AWS 자격증명 구성
- EKS 운영 리전 확정 (예: `ap-northeast-2`)
- 도메인(Route53)과 ACM 인증서 준비

## 2) 컨테이너 이미지 빌드/푸시 (ECR)
```bash
# 변수
AWS_REGION=ap-northeast-2
AWS_ACCOUNT_ID=111111111111
ECR_SERVER_REPO=playasset-server
ECR_WEB_REPO=playasset-web
IMAGE_TAG=2026.02.15-01

aws ecr create-repository --repository-name $ECR_SERVER_REPO --region $AWS_REGION || true
aws ecr create-repository --repository-name $ECR_WEB_REPO --region $AWS_REGION || true

aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

# backend
docker build -t playasset-server:$IMAGE_TAG ./Server/playasset
docker tag playasset-server:$IMAGE_TAG ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_SERVER_REPO}:$IMAGE_TAG
docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_SERVER_REPO}:$IMAGE_TAG

# web
docker build -t playasset-web:$IMAGE_TAG ./UI/playasset_flutter
docker tag playasset-web:$IMAGE_TAG ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_WEB_REPO}:$IMAGE_TAG
docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_WEB_REPO}:$IMAGE_TAG
```

## 3) EKS 클러스터 생성 (예시)
```bash
CLUSTER_NAME=playasset-prod
AWS_REGION=ap-northeast-2

eksctl create cluster \
  --name $CLUSTER_NAME \
  --region $AWS_REGION \
  --nodes 3 \
  --node-type m6i.large \
  --managed
```

## 4) AWS Load Balancer Controller 설치
```bash
CLUSTER_NAME=playasset-prod
AWS_REGION=ap-northeast-2
ACCOUNT_ID=111111111111

helm repo add eks https://aws.github.io/eks-charts
helm repo update

kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller/crds?ref=master"

helm upgrade -i aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=$CLUSTER_NAME \
  --set serviceAccount.create=true \
  --set region=$AWS_REGION \
  --set vpcId=vpc-REPLACE_ME
```

## 5) K8s 매니페스트 반영
1. `infra/k8s/base/server.yaml`, `infra/k8s/base/web.yaml`의 이미지를 ECR 경로로 교체
2. `infra/k8s/base/ingress.yaml`의 도메인/인증서 ARN 교체
3. 시크릿 값 교체

```bash
kubectl apply -k infra/k8s/base
kubectl get pods -n playasset
kubectl get svc -n playasset
kubectl get ingress -n playasset
```

## 6) 퍼블릭 엔드포인트 연결
- `kubectl get ingress -n playasset`로 ALB DNS 확인
- Route53에서 `app.example.com` -> ALB DNS Alias 연결
- HTTPS 인증서가 올바른 ARN인지 확인

## 7) 운영 점검 체크
- `https://app.example.com` 접속
- `https://app.example.com/api/v1/users/1001/dashboard` 응답 확인
- `/actuator/health` 헬스체크 확인
- ALB Target Group healthy 확인

## 8) CI/CD 연결 포인트
- GitHub Actions에서 ECR push 후 `kubectl rollout restart` 또는 ArgoCD/Flux로 GitOps 반영
- 필요한 GitHub Secrets
  - `AWS_ACCESS_KEY_ID`
  - `AWS_SECRET_ACCESS_KEY`
  - `AWS_REGION`
  - `EKS_CLUSTER_NAME`

## 9) 권장 운영 고도화
- RDS(MySQL) + ElastiCache(Redis)로 상태 저장소 분리
- Kafka는 MSK 또는 다중 브로커 K8s 구성으로 전환
- HPA(서버/웹), PodDisruptionBudget, NetworkPolicy 추가
